stages:
  - clean
  - build
  - configure
  - apply_templates
  - test
  
image: python:2

variables:
  ANSIBLE_GATHERING: "smart"
  ANSIBLE_HOST_KEY_CHECKING: "false"
  ANSIBLE_RETRY_FILES_ENABLED: "false"
  ANSIBLE_ROLES_PATH: "./roles"
  ANSIBLE_SSH_PIPELINING: "true"
  ANSIBLE_LIBRARY: "./library"
  ANSIBLE_CONFIG: "./ansible.cfg"
  GIT_SUBMODULE_STRATEGY: "recursive"

clean:
  stage: clean
  script:
  - apt-get update -qy
  - apt-get install -y sshpass
  - pip install -r requirements.txt
  - ansible-playbook clean.yml
  only:
    changes:
      - inventory/viptela-workshop.yml

build:
  stage: build
  script:
  - apt-get update -qy
  - apt-get install -y sshpass
  - pip install -r requirements.txt
  - ansible-playbook build.yml

configure:
  stage: configure
  script:
  - apt-get update -qy
  - apt-get install -y sshpass
  - pip install -r requirements.txt
  - ansible-playbook configure.yml
  - ansible-playbook import-templates.yml

apply_templates:
  stage: apply_templates
  script:
  - apt-get update -qy
  - apt-get install -y sshpass
  - pip install -r requirements.txt
  - ansible-playbook attach-template.yml
 
test:
  stage: test
  script:
  - apt-get update -qy
  - apt-get install -y sshpass
  - pip install -r requirements.txt
  - ansible-playbook check-sdwan.yml
