stages:
  - build_container
  - clean
  - build_topology
  - configure
  - apply_templates
  - test

image: ansible-viptela

variables:
  ANSIBLE_GATHERING: "smart"
  ANSIBLE_HOST_KEY_CHECKING: "false"
  ANSIBLE_RETRY_FILES_ENABLED: "false"
  ANSIBLE_ROLES_PATH: "./roles"
  ANSIBLE_SSH_PIPELINING: "true"
  ANSIBLE_LIBRARY: "./library"
  ANSIBLE_CONFIG: "./ansible.cfg"
  GIT_SUBMODULE_STRATEGY: "recursive"

build_container:
  stage: build_container
  image: docker:19.03.1
  script:
  - docker build -t ansible-viptela .

clean:
  stage: clean
  script:
  - ansible-playbook clean.yml
  only:
    changes:
      - inventory/viptela-workshop.yml

build_topology:
  stage: build_topology
  script:
  - ansible-playbook build.yml

configure:
  stage: configure
  script:
  - ansible-playbook configure.yml
  - ansible-playbook import-templates.yml

apply_templates:
  stage: apply_templates
  script:
  - ansible-playbook waitfor-sync.yml
  - ansible-playbook attach-template.yml
 
test:
  stage: test
  script:
  - ansible-playbook check-sdwan.yml
